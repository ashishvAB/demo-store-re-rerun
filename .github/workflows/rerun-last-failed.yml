name: failed-only-reruns  
on:  
  workflow_dispatch:
 
jobs:  
  rerun:  
    runs-on: ubuntu-latest  
    container: mcr.microsoft.com/playwright:latest  
    env:  
      TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-node@v4  
        with: { node-version: '22.x' }
 
      - name: Create .env file
        run: |
          echo "USERNAME=${{ secrets.USERNAME }}" >> .env
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
          echo "NEW_PASSWORD=${{ secrets.NEW_PASSWORD }}" >> .env
          echo "FIRST_NAME=${{ secrets.FIRST_NAME }}" >> .env
          echo "STREET_NAME=${{ secrets.STREET_NAME }}" >> .env
          echo "CITY=${{ secrets.CITY }}" >> .env
          echo "STATE=${{ secrets.STATE }}" >> .env
          echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
          echo "ZIP_CODE=${{ secrets.ZIP_CODE }}" >> .env

      - name: Install deps  
        run: |  
          npm ci  
          npx playwright install --with-deps
 
      - name: Get last failed tests with tdpw  
        id: last_failed  
        run: |  
          # Get failed tests and handle empty results
          npx tdpw last-failed --token="${{ secrets.TESTDINO_TOKEN }}" > last_failed.txt || echo "No failed tests found"
          
          # Check if file has content and set output accordingly
          if [ -s last_failed.txt ]; then
            FAILED_ARGS=$(cat last_failed.txt | tr -d '\n\r')
            if [ -n "$FAILED_ARGS" ] && [ "$FAILED_ARGS" != "No failed tests found" ]; then
              echo "args=$FAILED_ARGS" >> $GITHUB_OUTPUT
              echo "has_failed_tests=true" >> $GITHUB_OUTPUT
              echo "Found failed tests: $FAILED_ARGS"
            else
              echo "args=" >> $GITHUB_OUTPUT
              echo "has_failed_tests=false" >> $GITHUB_OUTPUT
              echo "No failed tests to rerun"
            fi
          else
            echo "args=" >> $GITHUB_OUTPUT
            echo "has_failed_tests=false" >> $GITHUB_OUTPUT
            echo "No failed tests to rerun"
          fi

      - name: Run only failed tests  
        if: steps.last_failed.outputs.has_failed_tests == 'true'
        run: npx playwright test ${{ steps.last_failed.outputs.args }}
        
      - name: Skip - No failed tests to rerun
        if: steps.last_failed.outputs.has_failed_tests == 'false'
        run: echo "No failed tests found to rerun. Skipping test execution."
 
      - name: Cache rerun metadata (always)  
        if: always()  
        run: npx tdpw cache --token="${{ secrets.TESTDINO_TOKEN }}"