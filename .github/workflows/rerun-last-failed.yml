name: failed-only-reruns  
on:  
  workflow_dispatch:
 
jobs:  
  rerun:  
    runs-on: ubuntu-latest  
    container: mcr.microsoft.com/playwright:latest  
    env:  
      TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-node@v4  
        with: { node-version: '22.x' }

      - name: Create .env file
        run: |
          echo "USERNAME=${{ secrets.USERNAME }}" >> .env
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
          echo "NEW_PASSWORD=${{ secrets.NEW_PASSWORD }}" >> .env
          echo "FIRST_NAME=${{ secrets.FIRST_NAME }}" >> .env
          echo "STREET_NAME=${{ secrets.STREET_NAME }}" >> .env
          echo "CITY=${{ secrets.CITY }}" >> .env
          echo "STATE=${{ secrets.STATE }}" >> .env
          echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
          echo "ZIP_CODE=${{ secrets.ZIP_CODE }}" >> .env

      - name: Install deps  
        run: |  
          npm ci  
          npx playwright install --with-deps
 
      - name: Get last failed tests with tdpw  
        id: last_failed  
        run: |  
          # Get the last line which should contain the actual test args
          FAILED_TESTS=$(npx tdpw last-failed --token="${{ secrets.TESTDINO_TOKEN }}" | tail -1)
          echo "args=$FAILED_TESTS" >> $GITHUB_OUTPUT
 
      - name: Run only failed tests  
        run: npx playwright test ${{ steps.last_failed.outputs.args }}
 
      - name: Cache rerun metadata (always)  
        if: always()  
        run: npx tdpw cache --token="${{ secrets.TESTDINO_TOKEN }}"


      - name: Send TestDino report
        if: always()
        run: |
         npx --yes tdpw ./playwright-report --token="${{ secrets.TESTDINO_TOKEN }}" --upload-html --verbose